#!/usr/bin/with-contenv bash
set -euo pipefail

# Ensure DISPATCHARR_ENV is set for aio mode
export DISPATCHARR_ENV="${DISPATCHARR_ENV:-aio}"

# Set port configuration
export DISPATCHARR_PORT=9191

# For entrypoint.aio.sh (Gunicorn mode)
export GUNICORN_PORT=9191
export GUNICORN_BIND="0.0.0.0:9191"

# Additional environment variables for compatibility
export PORT=9191
export HOST=0.0.0.0

echo "Starting Dispatcharr..." >&2
echo "  Environment: $DISPATCHARR_ENV" >&2
echo "  Port: $DISPATCHARR_PORT" >&2

# Priority order: /app/docker/entrypoint.sh (actual) > entrypoint.aio.sh > entrypoint.sh
if [ -f /app/docker/entrypoint.sh ]; then
    echo "Using /app/docker/entrypoint.sh" >&2
    exec /app/docker/entrypoint.sh
elif [ -f /entrypoint.aio.sh ]; then
    echo "Using /entrypoint.aio.sh" >&2
    exec /entrypoint.aio.sh
elif [ -f /entrypoint.sh ]; then
    echo "Using /entrypoint.sh" >&2
    exec /entrypoint.sh
else
    echo "ERROR: No entrypoint script found. Checked:" >&2
    echo "  - /app/docker/entrypoint.sh" >&2
    echo "  - /entrypoint.aio.sh" >&2
    echo "  - /entrypoint.sh" >&2
    exit 1
fi
