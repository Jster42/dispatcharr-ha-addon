#!/usr/bin/with-contenv bash
set -euo pipefail

# Ensure DISPATCHARR_ENV is set for aio mode (required for entrypoint.aio.sh)
export DISPATCHARR_ENV="${DISPATCHARR_ENV:-aio}"

# Verify Gunicorn will bind to the correct port for Ingress
export GUNICORN_PORT=9191

# Use the upstream entrypoint.aio.sh from dev branch (starts Redis, Celery, Gunicorn)
# Try entrypoint.aio.sh first (dev branch), then fallback to entrypoint.sh
if [ -f /entrypoint.aio.sh ]; then
    echo "Starting Dispatcharr with /entrypoint.aio.sh (env: $DISPATCHARR_ENV, port: $GUNICORN_PORT)" >&2
    exec /entrypoint.aio.sh
elif [ -f /entrypoint.sh ]; then
    echo "Starting Dispatcharr with /entrypoint.sh" >&2
    exec /entrypoint.sh
else
    echo "ERROR: No entrypoint script found (/entrypoint.aio.sh or /entrypoint.sh)" >&2
    exit 1
fi
