#!/usr/bin/with-contenv bash
set -euo pipefail
CONFIG=/data/options.json

# Set base environment (matching docker-compose.aio.yml from dev branch)
export DISPATCHARR_ENV=aio
export DISPATCHARR_LOG_LEVEL=info
# Set port for nginx
export DISPATCHARR_PORT=9191

# Apply nginx optimizations for better performance
NGINX_TEMPLATE="/etc/nginx/sites-enabled/default"

# Clean up any existing .bak files first
rm -f "${NGINX_TEMPLATE}.bak" 2>/dev/null || true

if [ -f "$NGINX_TEMPLATE" ] && grep -q "listen NGINX_PORT" "$NGINX_TEMPLATE" 2>/dev/null; then
    # Disable uwsgi buffering for better response handling
    if ! grep -q "uwsgi_buffering off" "$NGINX_TEMPLATE" 2>/dev/null; then
        echo "Disabling uwsgi buffering..." >&2
        sed -i '0,/uwsgi_pass unix:\/app\/uwsgi.sock;/{
            /uwsgi_pass unix:\/app\/uwsgi.sock;/a\
        uwsgi_buffering off;
        uwsgi_request_buffering off;
        }' "$NGINX_TEMPLATE" 2>/dev/null || true
    fi
    
    # Disable sendfile and enable tcp_nodelay for better performance
    if ! grep -q "sendfile off" "$NGINX_TEMPLATE" 2>/dev/null; then
        echo "Optimizing nginx sendfile settings..." >&2
        sed -i '/uwsgi_request_buffering off;/a\
        sendfile off;
        tcp_nopush off;
        tcp_nodelay on;
' "$NGINX_TEMPLATE" 2>/dev/null || true
    fi
    
    # Enable uwsgi_ignore_client_abort for better connection handling
    if ! grep -q "uwsgi_ignore_client_abort" "$NGINX_TEMPLATE" 2>/dev/null; then
        echo "Enabling uwsgi_ignore_client_abort..." >&2
        sed -i '/uwsgi_request_buffering off;/a\
        uwsgi_ignore_client_abort on;
' "$NGINX_TEMPLATE" 2>/dev/null || true
    fi
fi

if [ -f "$CONFIG" ]; then
  USERNAME=$(jq -r '.username' "$CONFIG")
  PASSWORD=$(jq -r '.password // empty' "$CONFIG")
  EPG_URL=$(jq -r '.epg_url' "$CONFIG")
  TZ_OPT=$(jq -r '.timezone' "$CONFIG")
  export DISPATCHARR_USERNAME="$USERNAME"
  export DISPATCHARR_PASSWORD="$PASSWORD"
  export DISPATCHARR_EPG_URL="$EPG_URL"
  export TZ="${TZ_OPT:-UTC}"
  # Persist a simple env file (optional)
  cat > /data/dispatcharr.env <<EOF
DISPATCHARR_ENV=aio
DISPATCHARR_LOG_LEVEL=info
DISPATCHARR_PORT=9191
DISPATCHARR_USERNAME=$DISPATCHARR_USERNAME
DISPATCHARR_PASSWORD=$DISPATCHARR_PASSWORD
DISPATCHARR_EPG_URL=$DISPATCHARR_EPG_URL
TZ=$TZ
EOF
fi
