#!/usr/bin/with-contenv bash
set -euo pipefail
CONFIG=/data/options.json

# Set base environment (matching docker-compose.aio.yml from dev branch)
export DISPATCHARR_ENV=aio
export DISPATCHARR_LOG_LEVEL=info
# Set port for Ingress - nginx will listen on this port
export DISPATCHARR_PORT=9191

if [ -f "$CONFIG" ]; then
  USERNAME=$(jq -r '.username' "$CONFIG")
  PASSWORD=$(jq -r '.password // empty' "$CONFIG")
  EPG_URL=$(jq -r '.epg_url' "$CONFIG")
  TZ_OPT=$(jq -r '.timezone' "$CONFIG")
  export DISPATCHARR_USERNAME="$USERNAME"
  export DISPATCHARR_PASSWORD="$PASSWORD"
  export DISPATCHARR_EPG_URL="$EPG_URL"
  export TZ="${TZ_OPT:-UTC}"
  # Persist a simple env file (optional)
  cat > /data/dispatcharr.env <<EOF
DISPATCHARR_ENV=aio
DISPATCHARR_LOG_LEVEL=info
DISPATCHARR_PORT=9191
DISPATCHARR_USERNAME=$DISPATCHARR_USERNAME
DISPATCHARR_PASSWORD=$DISPATCHARR_PASSWORD
DISPATCHARR_EPG_URL=$DISPATCHARR_EPG_URL
TZ=$TZ
EOF
fi
